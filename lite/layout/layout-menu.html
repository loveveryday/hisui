<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
    <title>HIS UI</title>
    <link rel="stylesheet" type="text/css" href="../../dist/css/hisui.lite.css">
    <script type="text/javascript" src="../../dist/js/jquery-1.11.3.min.js"></script>
    <script type="text/javascript" src="../../dist/js/jquery.hisui.min.js"></script>
    <script type="text/javascript" src="../../dist/js/locale/hisui-lang-zh_CN.js"></script>

    <link rel="stylesheet" type="text/css" href="../demo.css">
    <style>
        td.l-value{
            text-align: left;
            padding-right: 20px;
        }

        .menu-tree-tip-count{
            display: block;
            position: absolute;
            right: 20px;
            top: 10px;
            width: 16px;
            height: 16px;
            background-color: #E4E4E4;
            border-radius: 4px;
            line-height: 16px;
            text-align: center;
            font-size: 12px;
            color:#666666;
        }
        .tree-node-selected .menu-tree-tip-count,
        .tree-node-hover .menu-tree-tip-count{
            background-color: #FFE9E9;
            color: #EE0F0F;
        }
		.reg-word{
			background-color:yellow;  
			color:#000; 
		}
		.tree-node-hidden{
			display:none;	
		}
    </style>
    <script src="../jquery-tag-demo.js" type="text/javascript"></script>

    <script src="../mock-min.js" type="text/javascript"></script>
    <script src="../tpl/data.js" type="text/javascript"></script>
</head>
<body class="hisui-layout">
    <div data-options="region:'west',border:false" style="width:190px;padding:10px 0 10px 10px;" >
        <div class="hisui-layout" data-options="fit:true" >
            <div data-options="region:'north',border:false" style="height: 40px;">
                <input type="text" class="hisui-searchbox" id="menu-tree-searcher" data-options="width:180">
            </div>
            <div data-options="region:'center'" style="">
                <ul id="menu-tree" style="width:178px;" class="menutree" data-options="animate:true"></ul>
            </div>
        </div>
    </div>
    <div data-options="region:'center',border:false" style="padding: 10px;">
        <div class="hisui-tabs" id="menu-tabs" data-options="fit:true" >
            <div title="首页" style="padding: 10px;">首页内容</div>
        </div>
    </div>
    <script type="text/javascript">
        $(function(){
            var myMenuData=[];
            for(var i=1;i<4;i++){
                var item={id:i+'',text:'一级菜单'+i,state:'open',children:[]}
                for (var j=1;j<(7-i);j++){
                    item.children.push({
                        id:i+'-'+j,
                        text:'二级菜单'+i+'-'+j,
                        state:'open',
                        attributes:{
                            url:'./layout-query.html',
                            count:(i==1&&j<=2)?j:0
                        }
                    })

                }
                myMenuData.push(item);
                
            }
            Mock.mock("getMenuData", function( options ){
                console.log("getMenuData请求开始了",options);
                var obj=myMenuData
                console.log("getMenuData请求结束了，结果",obj);
                return obj;

            })

            var addOrOpenTab=function(tabOpts){
                var tab=$('#menu-tabs').tabs('getTab',tabOpts.title)
                if (tab){
                    $('#menu-tabs').tabs('select',tabOpts.title)
                }else{
                    var myTabOpts={
                        title:tabOpts.title,
                        content:'<iframe name="menu-tabs-frame-'+tabOpts.code+'" src="'+tabOpts.url+'" style="display:block;width: 100%;height: 100%; margin:0; border: 0;" scroll="auto"></iframe>',
                        closable:true
                    }
                    $('#menu-tabs').tabs('add',myTabOpts)

                }
            }

            
            $('#menu-tree').tree({
                url:'getMenuData',
                formatter:treeNodeFormatter,
                onClick: function (node) {
                    console.log(node)
                    if(node && node.attributes &&node.attributes.url) {
                        addOrOpenTab($.extend({
                            code:node.id,
                            title:node.text
                        },node.attributes))
                    }
                }
            })
            function treeNodeFormatter(node,search){
                console.log(arguments)
                var text=node.text;
                if (search&&search!='') {
                    var reg=new RegExp(search, 'ig');
                    text=text.replace(reg,"<span class='reg-word'>"+search+"</span>");
                }

                if(node && node.attributes &&node.attributes.count>0) {
                    return text+' '+'<span class="menu-tree-tip-count">'+node.attributes.count+'</span>'
                }else{
                    return text;
                }
            }
            function formatData(data,search,parent){
                var flag=false,
                    pok=(parent && parent.ok),
                    search=search.toLowerCase();
                for(var i=0;i<data.length;i++){
                    var item=data[i];
                    item.ok=false;
                    if(pok){
                        item.ok=true;
                    }else{
                        var text=item.text.toLowerCase();
                        if (text.indexOf(search)>-1) {
                            item.ok=true;
                        }else{
                            var spellArr=$.hisui.getChineseSpellArray(text);
                            var len=spellArr.length;

                            var spellMatch=false;
                            for (var j=0;j<len;j++){
                                var spellL=(spellArr[j]||'').toLowerCase();
                                var spellIndex=spellL.indexOf(search);
                                if(spellIndex>-1) {
                                    item.ok=true;
                                    break;
                                }

                            }
                        }
                    }
                    if (item.children ){
                        formatData(item.children,search,item);
                    }
                    if (item.ok) flag=true;
                }
                if (flag && parent) parent.ok=true;
            }
            function formatNode(data,search,isRoot,keepRoot){
                for(var i=0;i<data.length;i++){
                    var item=data[i];
                    
                    if (item.children ){
                        formatNode(item.children,search,false,keepRoot);
                    }
                    var t=$("#"+item.domId);
                    
                    if (isRoot && keepRoot){
                        //保持根节点并且是根节点 不用处理
                    }else if (item.ok) {
                        var html=treeNodeFormatter(item,search);
                        t.find('.tree-title').html(html);
                        t.removeClass('tree-node-hidden');  
                    } else{
                        t.addClass('tree-node-hidden');
                    }
                }
            }
            $('#menu-tree-searcher').searchbox({
                    searcher:function (value){
                    var data=$('#menu-tree').tree('getRoots');
                    formatData(data,value);
                    formatNode(data,value,true,true);
                }
            })
            
        })
    </script>
</body>
</html>